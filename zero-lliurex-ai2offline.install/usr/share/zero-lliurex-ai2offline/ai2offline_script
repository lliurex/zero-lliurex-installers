#!/bin/bash


ACTION="$1"
URL="https://deac-ams.dl.sourceforge.net/project/ai2offline/7.4/AI2Offline7.4.7z"
#This is a magic link, so it could change
URL_DATA="https://files.appinventor.mit.edu/api/public/dl/vlwV6uq3"
DEST_DOWNLOAD="/opt/ai2offline/"
TEMP_DOWNLOAD="/tmp/.ai2data/"
DEST_DATA_FILE=${TEMP_DOWNLOAD}"ai2offline-data.tar.gz"
DEST_FILE=$DEST_DOWNLOAD"ai2offline.7z"
AI2FOLDER=$DEST_DOWNLOAD"AI2Offline7.4/"
AISERVER_SCRIPT=$AI2FOLDER"startAIServer.sh"
AIBUILDER_SCRIPT=$AI2FOLDER"startBuildServer.sh"
DESKTOP_ORIG="/usr/share/zero-lliurex-ai2offline/desktops/*.desktop"
DESKTOP_DEST="/usr/share/applications/"
BIN_ORIG="/usr/share/zero-lliurex-ai2offline/bin/*"
BIN_DEST="/usr/bin/"
DEPENDS_AI2="lib32stdc++6 lib32z1"

case $ACTION in

	getStatus)
		if [ -s ${DEST_FILE} ]
		then	
			echo 0
		else
			echo 1	
		fi				
	;;

	download)

		if ! [ -d ${DEST_DOWNLOAD} ]
		then
			mkdir ${DEST_DOWNLOAD}
		fi

		cd ${DEST_DOWNLOAD}

		if [ -s ${DEST_FILE} ]
		then
			rm -f ${DEST_FILE}
			rm -rf ${AI2FOLDER}
		fi

		wget ${URL} -O ${DEST_FILE}
		
		if ! [ -s ${DEST_FILE} ]
		then	
			exit 1
		fi	

		if [ -d ${TEMP_DOWNLOAD} ]
		then
			rm -fr ${TEMP_DOWNLOAD}
		fi

		mkdir ${TEMP_DOWNLOAD}
		wget ${URL_DATA} -O ${DEST_DATA_FILE}

		if ! [ -s ${DEST_DATA_FILE} ]
		then	
			exit 1
		fi	
	;;	

	preInstall)
		echo "Installing needed packages"
		for PKG in $DEPENDS_AI2
		do
			apt-get install --yes  $PKG
		done
	;;
	
	installPackage)

		echo "Unzip $DEST_FILE..."
		
		cd ${DEST_DOWNLOAD}
		7z x ${DEST_FILE}
		
		echo "Enable others write access..."
		chmod 777 -R ${AI2FOLDER}
		
		echo "Enable execution flag in scripts..."
		chmod +x ${AISERVER_SCRIPT}
		chmod +x ${AIBUILDER_SCRIPT}


		echo "Copy desktop files..."
		cp $DESKTOP_ORIG $DESKTOP_DEST
		sleep 5
		
		echo "Copy bin files..."
		cp $BIN_ORIG $BIN_DEST
		
		echo "Extracting data..."
		cd $TEMP_DOWNLOAD
		tar -zxf $DEST_DATA_FILE
		rm $DEST_DATA_FILE
		RELEASE_DIR=$(ls | head -n1)
		cd $OLDPWD

		echo "Setting up paths..."
		#Put tools on aistarter
		AILINUX_FOLDER=${AI2FOLDER}"aiStarter-linux/"
		ln -s ${AILINUX_FOLDER}from-Android-SDK/platform-tools/* ${AILINUX_FOLDER}
		cd ${DEST_DOWNLOAD}
		#Copy tools from data
		cp -r ${TEMP_DOWNLOAD}${RELEASE_DIR}/appinventor/from-Android-SDK/ ${AI2FOLDER}
		cp -r ${TEMP_DOWNLOAD}${RELEASE_DIR}/appinventor/extras ${AI2FOLDER}
		rm -fr $TEMP_DOWNLOAD
		
	
	;;

	remove)
		
		echo "Removing files..."

	
		
		if [ -s ${DEST_DOWNLOAD}${DEST_FILE} ]
		then
			rm -f ${DEST_DOWNLOAD}${DEST_FILE}
		fi

		if [ -s ${DEST_DOWNLOAD}${DEST_FILE} ]
		then	
			exit 1
		fi
	


	;;		
		
esac
exit 0
